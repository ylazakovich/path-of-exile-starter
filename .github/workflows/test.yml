name: "Run tests"
on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
permissions:
  pull-requests: write
  checks: write
env:
  CI: true
  GRADLE_OPTS: -Dorg.gradle.console=plain
  COMPOSE_PROJECT_NAME: path-of-exile-starter

jobs:
  run-tests-on-linux:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        gradle-task: ["check"]
    steps:
      - name: ðŸ”¨Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - name: ðŸ”¨Set up JDK
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5
        with:
          distribution: "temurin"
          cache: "gradle"
          java-version: "25"
      - name: ðŸ”§ Set up Node.js for Allure CLI
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: "20"
      - name: ðŸ”¨ Build with Gradle
        uses: gradle/actions/setup-gradle@4d9f0ba0025fe599b4ebab900eb7f3a1d93ef4c2 # v5
      - name: ðŸŸ¢ Start Application
        uses: ylazakovich/compose-health-check-action@d2d6a1671208fcf0f455f8a4ffe3a87a9da13c74
        with:
          docker-command: |
            docker compose \
              -f tools/docker/docker-compose.yml \
              -f tools/docker/docker-compose.override.yml \
              up -d --quiet-pull spring-webflux-aggregator spring-telegram-webhook
          log-lines: 100
      - name: ðŸš€ Run the unit tests
        run: ./gradlew ${{ matrix.gradle-task }} --no-parallel --no-daemon --console=plain
        shell: bash
      - name: ðŸ“Š Generate Allure report
        if: always()
        run: |
          set -euo pipefail
          mkdir -p allure-results
          found=0
          while IFS= read -r -d '' dir; do
            found=1
            cp -a "$dir/." allure-results/
          done < <(find . -type d -path "*/build/allure-results" -print0)
          if [ "$found" -eq 0 ]; then
            echo "No allure-results found, skipping report generation."
            exit 0
          fi
          npx --yes allure generate allure-results -o allure-report
      - name: ðŸ§¾ Publish Allure summary to PR
        if: always() && github.event_name == 'pull_request'
        uses: allure-framework/allure-action@v0
        with:
          report-directory: "./allure-report"
          github-token: ${{ secrets.GITHUB_TOKEN }}
      - name: ðŸ“¦ Packing test results as artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        if: always()
        with:
          name: test-report-linux-${{ matrix.gradle-task }}
          retention-days: 3
          path: |
            **/build/reports
            **/build/test-results
      - name: ðŸ“¦ Upload Allure report artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        if: always()
        with:
          name: allure-report-linux-${{ matrix.gradle-task }}
          retention-days: 3
          if-no-files-found: warn
          path: |
            allure-report
