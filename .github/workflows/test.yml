name: "Run tests"
on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
env:
  CI: true
  GRADLE_OPTS: -Dorg.gradle.console=plain

jobs:
  run-tests-on-linux:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        gradle-task: ["check"]
    steps:
      - name: ðŸ”¨Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - name: ðŸ”¨Set up JDK
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5
        with:
          distribution: "temurin"
          cache: "gradle"
          java-version: "25"
      - name: ðŸ”¨ Build with Gradle
        uses: gradle/actions/setup-gradle@4d9f0ba0025fe599b4ebab900eb7f3a1d93ef4c2 # v5
      - name: ðŸŸ¢ Start Application
        uses: ylazakovich/compose-health-check-action@v2.1.1
        with:
          docker-command: |
            docker compose \
              -f tools/docker/docker-compose.yml \
              -f tools/docker/docker-compose.override.yml \
              up -d --quiet-pull spring-webflux-aggregator spring-telegram-webhook
          log-lines: 100
      - name: ðŸš€ Run the unit tests
        run: ./gradlew ${{ matrix.gradle-task }} --no-parallel --no-daemon --console=plain
        shell: bash
      - name: ðŸ“¦ Packing test results as artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        if: always()
        with:
          name: test-report-linux-${{ matrix.gradle-task }}
          retention-days: 3
          path: |
            **/build/reports
            **/build/test-results
