name: "Run tests"
on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]
permissions:
  pull-requests: write
  checks: write
  contents: write
env:
  CI: true
  GRADLE_OPTS: -Dorg.gradle.console=plain
  COMPOSE_PROJECT_NAME: path-of-exile-starter
  COMPOSE_PROFILES: mock
  NINJA_USE_MOCK_SERVER_AS_PROXY: "true"
  PATH_OF_EXILE_USE_MOCK_SERVER_AS_PROXY: "true"
  MOCK_SERVER_HOST: mock-server
  MOCK_SERVER_PORT: "1080"

jobs:
  run-tests-on-linux:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        gradle-task: [ "check" ]
    steps:
      - name: üî®Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - name: üî®Set up JDK
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5
        with:
          distribution: "temurin"
          cache: "gradle"
          java-version: "25"
      - name: üîß Set up Node.js for Allure CLI
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: "24"
      - name: üî® Build with Gradle
        uses: gradle/actions/setup-gradle@4d9f0ba0025fe599b4ebab900eb7f3a1d93ef4c2 # v5
      - name: üß™ Upload mock expectations
        run: tools/scripts/mock/run_mock_server.sh
        shell: bash
      - name: üü¢ Start Application
        uses: ylazakovich/compose-health-check-action@3cb636a618a1c8e30ba6b014a2b7d2c5f635e61b
        with:
          docker-command: |
            docker compose \
              -f tools/docker/docker-compose.yml \
              -f tools/docker/docker-compose.override.yml \
              --profile mock \
              up -d --quiet-pull spring-webflux-aggregator spring-telegram-webhook
          log-lines: 100
      - name: üöÄ Run the unit tests
        run: ./gradlew ${{ matrix.gradle-task }} --no-parallel --no-daemon --console=plain
        shell: bash
      - name: üìä Generate Allure report
        id: allure-generate
        if: always()
        run: |
          set -euo pipefail
          mkdir -p allure-results
          found=0
          while IFS= read -r -d '' dir; do
            found=1
            cp -a "$dir/." allure-results/
          done < <(find . -type d -path "*/build/allure-results" -print0)
          if [ "$found" -eq 0 ]; then
            echo "No allure-results found, skipping report generation."
            echo "found=0" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          npx --yes allure generate allure-results -o allure-report
          echo "found=1" >> "$GITHUB_OUTPUT"
      - name: üßæ Publish Allure summary to PR
        if: always() && github.event_name == 'pull_request' && steps.allure-generate.outputs.found == '1'
        uses: allure-framework/allure-action@d83330ab1b8022523272800026668fa0fbd3e831 # v0
        with:
          report-directory: "./allure-report"
          github-token: ${{ secrets.GITHUB_TOKEN }}
      - name: üåê Publish Allure report to GitHub Pages
        if: always() && github.ref == 'refs/heads/main' && steps.allure-generate.outputs.found == '1'
        uses: peaceiris/actions-gh-pages@4f9cc6602d3f66b9c108549d475ec49e8ef4d45e # v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./allure-report
      - name: üåê Publish Allure PR preview to GitHub Pages
        if: always() && github.event_name == 'pull_request' && steps.allure-generate.outputs.found == '1' && github.event.pull_request.head.repo.full_name == github.repository
        uses: peaceiris/actions-gh-pages@4f9cc6602d3f66b9c108549d475ec49e8ef4d45e # v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./allure-report
          destination_dir: pr-${{ github.event.pull_request.number }}
      - name: üìù Add Allure report link to PR
        if: always() && github.event_name == 'pull_request' && steps.allure-generate.outputs.found == '1'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        env:
          ALLURE_REPORT_URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/pr-${{ github.event.pull_request.number }}/
        with:
          script: |
            const body = `Allure report: ${process.env.ALLURE_REPORT_URL}`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });
      - name: üì¶ Packing test results as artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        if: always()
        with:
          name: test-report-linux-${{ matrix.gradle-task }}
          retention-days: 3
          path: |
            **/build/reports
            **/build/test-results
      - name: üì¶ Upload Allure report artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        if: always()
        with:
          name: allure-report-linux-${{ matrix.gradle-task }}
          retention-days: 3
          if-no-files-found: warn
          path: |
            allure-report
