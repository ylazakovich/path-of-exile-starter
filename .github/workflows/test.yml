name: "Run tests"
on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
permissions:
  pull-requests: write
  checks: write
  contents: write
env:
  CI: true
  GRADLE_OPTS: -Dorg.gradle.console=plain
  COMPOSE_PROJECT_NAME: path-of-exile-starter

jobs:
  run-tests-on-linux:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        gradle-task: ["check"]
    steps:
      - name: ğŸ”¨Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - name: ğŸ”¨Set up JDK
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5
        with:
          distribution: "temurin"
          cache: "gradle"
          java-version: "25"
      - name: ğŸ”§ Set up Node.js for Allure CLI
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: "24"
      - name: ğŸ”¨ Build with Gradle
        uses: gradle/actions/setup-gradle@4d9f0ba0025fe599b4ebab900eb7f3a1d93ef4c2 # v5
      - name: ğŸŸ¢ Start Application
        uses: ylazakovich/compose-health-check-action@d2d6a1671208fcf0f455f8a4ffe3a87a9da13c74
        with:
          docker-command: |
            docker compose \
              -f tools/docker/docker-compose.yml \
              -f tools/docker/docker-compose.override.yml \
              up -d --quiet-pull spring-webflux-aggregator spring-telegram-webhook
          log-lines: 100
      - name: ğŸš€ Run the unit tests
        run: ./gradlew ${{ matrix.gradle-task }} --no-parallel --no-daemon --console=plain
        shell: bash
      - name: ğŸ“Š Generate Allure report
        id: allure-generate
        if: always()
        run: |
          set -euo pipefail
          mkdir -p allure-results
          found=0
          while IFS= read -r -d '' dir; do
            found=1
            cp -a "$dir/." allure-results/
          done < <(find . -type d -path "*/build/allure-results" -print0)
          if [ "$found" -eq 0 ]; then
            echo "No allure-results found, skipping report generation."
            echo "found=0" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          npx --yes allure generate allure-results -o allure-report
          echo "found=1" >> "$GITHUB_OUTPUT"
      - name: ğŸ§¾ Publish Allure summary to PR
        if: always() && github.event_name == 'pull_request' && steps.allure-generate.outputs.found == '1'
        uses: allure-framework/allure-action@v0
        with:
          report-directory: "./allure-report"
          github-token: ${{ secrets.GITHUB_TOKEN }}
      - name: ğŸŒ Publish Allure report to GitHub Pages
        if: always() && github.ref == 'refs/heads/main' && steps.allure-generate.outputs.found == '1'
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./allure-report
      - name: ğŸŒ Publish Allure PR preview to GitHub Pages
        if: always() && github.event_name == 'pull_request' && steps.allure-generate.outputs.found == '1' && github.event.pull_request.head.repo.full_name == github.repository
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./allure-report
          destination_dir: pr-${{ github.event.pull_request.number }}
      - name: ğŸ“ Add Allure report link to PR
        if: always() && github.event_name == 'pull_request' && steps.allure-generate.outputs.found == '1'
        uses: actions/github-script@v7
        env:
          ALLURE_REPORT_URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/pr-${{ github.event.pull_request.number }}/
        with:
          script: |
            const body = `Allure report: ${process.env.ALLURE_REPORT_URL}`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });
      - name: ğŸ“¦ Packing test results as artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        if: always()
        with:
          name: test-report-linux-${{ matrix.gradle-task }}
          retention-days: 3
          path: |
            **/build/reports
            **/build/test-results
      - name: ğŸ“¦ Upload Allure report artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        if: always()
        with:
          name: allure-report-linux-${{ matrix.gradle-task }}
          retention-days: 3
          if-no-files-found: warn
          path: |
            allure-report
