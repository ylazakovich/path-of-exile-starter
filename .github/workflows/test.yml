name: "Run tests"
on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
env:
  CI: true
  GRADLE_OPTS: -Dorg.gradle.console=plain
  COMPOSE_PROJECT_NAME: path-of-exile-starter

jobs:
  run-tests-on-linux:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        gradle-task: ["check"]
    steps:
      - name: ðŸ”¨Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - name: ðŸ”¨Set up JDK
        uses: actions/setup-java@dded0888837ed1f317902acf8a20df0ad188d165 # v5
        with:
          distribution: "temurin"
          cache: "gradle"
          java-version: "25"
      - name: ðŸ”¨ Build with Gradle
        uses: gradle/actions/setup-gradle@4d9f0ba0025fe599b4ebab900eb7f3a1d93ef4c2 # v5
      - name: ðŸŸ¢ Start Application
        uses: ylazakovich/compose-health-check-action@f54b342732ca6bc3b61031715f6d850c60b528da # v1
        with:
          compose-files: |
            tools/docker/docker-compose.yml
            tools/docker/docker-compose.override.yml
          services: |
            spring-webflux-aggregator 
            spring-telegram-webhook
          additional-compose-args: "--quiet-pull"
          timeout: "120"
      - name: ðŸš€Run the unit tests
        run: ./gradlew ${{ matrix.gradle-task }} --no-parallel --no-daemon --console=plain
        shell: bash
      - name: ðŸ“¦Packing test results as artifact
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5
        if: always()
        with:
          name: test-report-linux-${{ matrix.gradle-task }}
          retention-days: 3
          path: |
            **/build/reports
            **/build/test-results
