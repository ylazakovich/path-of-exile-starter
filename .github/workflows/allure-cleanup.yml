name: "Cleanup Allure PR previews"
on:
  pull_request:
    types: [closed]
  schedule:
    - cron: "25 3 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  cleanup-allure-preview:
    runs-on: ubuntu-latest
    env:
      RETENTION_DAYS: "30"
    steps:
      - name: ðŸ”¨ Checkout default branch
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          fetch-depth: 0
      - name: ðŸ”Ž Check gh-pages branch exists
        id: gh-pages
        run: |
          set -euo pipefail
          if git ls-remote --exit-code --heads origin gh-pages >/dev/null 2>&1; then
            echo "exists=1" >> "$GITHUB_OUTPUT"
          else
            echo "exists=0" >> "$GITHUB_OUTPUT"
          fi
      - name: ðŸ§­ Checkout gh-pages
        if: steps.gh-pages.outputs.exists == '1'
        run: |
          set -euo pipefail
          git fetch origin gh-pages:gh-pages
          git checkout gh-pages
      - name: ðŸ§¹ Remove PR preview (on close)
        if: steps.gh-pages.outputs.exists == '1' && github.event_name == 'pull_request'
        run: |
          set -euo pipefail
          dir="pr-${{ github.event.pull_request.number }}"
          if [ ! -d "$dir" ]; then
            echo "Preview folder not found: $dir"
            exit 0
          fi
          now=$(date +%s)
          mtime=$(stat -c %Y "$dir")
          age_days=$(( (now - mtime) / 86400 ))
          if [ "$RETENTION_DAYS" -gt 0 ] && [ "$age_days" -lt "$RETENTION_DAYS" ]; then
            echo "Preview is $age_days days old (< $RETENTION_DAYS), keeping."
            exit 0
          fi
          rm -rf "$dir"
      - name: ðŸ§¹ Remove old PR previews (scheduled)
        if: steps.gh-pages.outputs.exists == '1' && github.event_name != 'pull_request'
        run: |
          set -euo pipefail
          now=$(date +%s)
          removed=0
          for dir in pr-*; do
            [ -d "$dir" ] || continue
            mtime=$(stat -c %Y "$dir")
            age_days=$(( (now - mtime) / 86400 ))
            if [ "$age_days" -ge "$RETENTION_DAYS" ]; then
              rm -rf "$dir"
              removed=1
            fi
          done
          echo "removed=$removed" >> "$GITHUB_OUTPUT"
      - name: ðŸ’¾ Commit and push changes
        if: steps.gh-pages.outputs.exists == '1'
        run: |
          set -euo pipefail
          if [ -z "$(git status --porcelain)" ]; then
            echo "No changes to commit."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "Cleanup Allure preview reports"
          git push
